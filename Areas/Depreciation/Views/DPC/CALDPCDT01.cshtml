
@{
    ViewBag.Title = "CALDPCDT01";
}
<div class="container">
    <div class="page-inner">
        <div class="page-header">
            <h3 class="fw-bold mb-3">การรับพ่อแม่พันธุ์ และการคำนวณค่าเสื่อมพ้นธุ์</h3>
            <ul class="breadcrumbs mb-3">
                <li class="nav-home">
                    <a href="#">
                        <i class="icon-home"></i>
                    </a>
                </li>
                <li class="separator">
                    <i class="icon-arrow-right"></i>
                </li>
                <li class="nav-item">
                    <a href="#">Tables</a>
                </li>
                <li class="separator">
                    <i class="icon-arrow-right"></i>
                </li>
                <li class="nav-item">
                    <a href="#">Datatables</a>
                </li>
            </ul>
        </div>
        <div class="row">
            <div class="col-md-12">
                <form class="m-form m-form--fit m-form--label-align-right">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title text-primary">ค้นหา</h1>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 col-lg-4">
                                    <div class="form-group">
                                        <div class="input-group mb-3">
                                            <span class="input-group-text col-lg-3" id="basic-addon1">เลขที่เอกสาร</span>
                                            <select class="form-select form-control dropdown-multiple" id="searchDocNo" name="searchDocNo">
                                                <option value="ALL">All</option>
                                                <option value="RE67-04010001">RE67-04010001</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 col-lg-4">
                                    <div class="form-group">
                                        <div class="input-group mb-3">
                                            <span class="input-group-text col-lg-3" id="basic-addon1">ฟาร์ม</span>
                                            <select class="form-select form-control dropdown-multiple" id="searchSiteId" name="searchSiteId">
                                                <option value="ALL">All</option>
                                                @foreach (var sit in ViewBag.MAS_SITE)
                                                {
                                                    <option value="@sit.SITE_ID">@sit.SITE_NM_TH</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <div class="form-group">
                                        <div class="input-group mb-3">
                                            <span class="input-group-text col-lg-4" id="basic-addon1">เล้า</span>
                                            <select class="form-select form-control dropdown-multiple" id="searchHousingTypeCode" name="searchHousingTypeCode">
                                                <option value="ALL">All</option>
                                                @foreach (var shg in ViewBag.MAS_HSG)
                                                {
                                                    <option value="@shg.HSG_TP_CODE">@shg.HSG_TP_NM</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <div class="form-group">
                                        <div class="input-group mb-3">
                                            <span class="input-group-text col-lg-3" id="basic-addon1">เบอร์หู</span>
                                            <select class="form-select form-control dropdown-multiple" id="searchBreeder" name="searchBreeder">
                                                <option value="ALL">All</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 col-lg-4">
                                    <div class="form-group">
                                        <div class="input-group mb-3">
                                            <span class="input-group-text col-lg-3" id="basic-addon1">ประเภท</span>
                                            <select class="form-select form-control dropdown-multiple" id="searchType" name="searchType">
                                                <option value="ALL">All</option>
                                                <option value="M">พ่อพันธุ์</option>
                                                <option value="F">แม่พันธุ์</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <div class="form-group">
                                        <div class="input-group mb-3">
                                            <span class="input-group-text col-lg-4" id="basic-addon1">จาก รหัสพ่อแม่พันธุ์</span>
                                            <select class="form-select form-control dropdown-multiple" id="searchFromBrdrId" name="searchFromBrdrId">
                                                <option value="ALL">All</option>
                                                @foreach (var dpc in ViewBag.V_DEPRECIATE)
                                                {
                                                    <option value="@dpc.BRDR_DPRC_CODE">@dpc.BRDR_DPRC_CODE</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <div class="form-group">
                                        <div class="input-group mb-3">
                                            <span class="input-group-text col-lg-3" id="basic-addon1">ถึง</span>
                                            <select class="form-select form-control dropdown-multiple" id="searchToBrdrId" name="searchToBrdrId">
                                                <option value="ALL">All</option>
                                                @foreach (var dpc in ViewBag.V_DEPRECIATE)
                                                {
                                                    <option value="@dpc.BRDR_DPRC_CODE">@dpc.BRDR_DPRC_CODE</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 col-lg-4">
                                    <div class="form-group">
                                        <div class="input-group mb-3">
                                            <span class="input-group-text col-lg-4" id="basic-addon1">สถานะการใช้งาน</span>
                                            <select class="form-select form-control" id="searchStatus" name="searchStatus">
                                                <option value="ALL">All</option>
                                                <option value="N" selected="selected">New</option>
                                                <option value="A">Active</option>
                                                <option value="I">In Active</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <!-- <div class="col-md-6 col-lg-4">
                        <div class="form-group">
                            <div class="input-group mb-3">
                                <span class="input-group-text col-lg-5" id="basic-addon1">สถานะการคำนวณค่าเสื่อมพันธุ์</span>
                                <input type="text"
                                        class="form-control"
                                        placeholder="No"
                                        aria-label="Username"
                                        aria-describedby="basic-addon1" />
                                <button class="btn btn-primary btn-border dropdown-toggle"
                                        type="button"
                                        data-bs-toggle="dropdown"
                                        aria-haspopup="true"
                                        aria-expanded="false"></button>
                            </div>
                        </div>
                    </div> -->
                            </div>
                        </div>
                        <div class="card-footer d-flex" style="justify-content:flex-end !important">
                            <button class="btn btn-primary btn-round">Search</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <div class="row">
                            <div class="col-md-6 col-lg-6">
                                <div class="form-group">
                                    <h6 class="card-title text-primary">รายการพ่อแม่พันธุ์ และค่าเสื่อมพันธุ์</h6>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-6">
                                <div class="form-group" style="justify-content:flex-end !important">
                                    <div class="input-group" style="justify-content:flex-end !important">
                                        <button class="btn btn-success btn-round">รายงานค่าเสื่อมพันธุ์ (Excel file)</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive tab-content mt-3 mb-3">
                            <div class="row" style="width:230%">
                                <div class="d-flex" style="justify-content:flex-end !important">
                                    <div class="col-md-1 col-lg-1">
                                        <div class="form-group">
                                            <div class="input-group mb-3">
                                                <input type="text"
                                                        id="bookValueDate"
                                                        name="bookValueDate"
                                                        class="form-control"
                                                        placeholder="Select Date"
                                                        aria-describedby="basic-addon1" />
                                                <span class="input-group-icon">
                                                    <i class="fas fa-calendar-alt"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-1 col-lg-1">
                                        <div class="form-group">
                                            <div class="input-group mb-3">
                                                <button id="calBookValue" class="btn btn-primary btn-round">คำนวณ Book Value</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <table id="tb_detail" style="width:230%" border="1"
                                    class="display table table-striped table-hover table-bordered">
                                <thead>
                                    <tr>
                                        <th width="2%" style="text-align:center !important">ลำดับ</th>
                                        <th></th>
                                        <th style="text-align:center !important">เลขที่เอกสาร</th>
                                        <th style="text-align:center !important">สถานะ</th>
                                        <th style="text-align:center !important">เล้า</th>
                                        <th style="text-align:center !important">เบอร์หู</th>
                                        <th style="text-align:center !important">ประเภท</th>
                                        <th style="text-align:center !important">รหัสพ่อแม่พันธุ์</th>
                                        <th style="text-align:center !important">ซื้อราคาตัวละ(บาท)</th>
                                        <th style="text-align:center !important">ราคาซาก/ตัว</th>
                                        <th style="text-align:center !important">มูลค่าที่ใช้คำนวณค่าเสื่อม(บาท)</th>
                                        <th style="text-align:center !important">วันที่ซื้อ/ได้มา</th>
                                        <th style="text-align:center !important">วันที่เริ่มคิดค่าเสื่อม</th>
                                        <th style="text-align:center !important">วันสุดท้ายที่คิดค่าเสื่อม</th>
                                        <th style="text-align:center !important">จำนวน(ปี)</th>
                                        <th style="text-align:center !important">จำนวน(วัน)</th>
                                        <th style="text-align:center !important">ค่าเสื่อมพันธุ์ต่อวัน(บาท)</th>
                                        <th style="text-align:center !important">วันสุดท้ายที่คิดค่าเสื่อม(5ปี)</th>
                                        <th style="text-align:center !important">จำนวน(ปี)(5ปี)</th>
                                        <th style="text-align:center !important">จำนวน(วัน)(5ปี)</th>
                                        <th style="text-align:center !important">ค่าเสื่อมพันธุ์ต่อวัน (5ปี) (บาท)</th>
                                        <th style="text-align:center !important">ณ วันที่ bookvalue</th>
                                        <th style="text-align:center !important">จำนวนวัน bookvalue</th>
                                        <th style="text-align:center !important">Book value (บาท)</th>
                                        @*<th width="5%" style="align-content:center; display: none;">
                                        <a href="3_1_1.html" class="d-flex align-items-center selectgroup-pills">
                                            <div class="selectgroup-button selectgroup-button-icon">
                                                <i class="fa fa-plus text-success"></i>
                                            </div>
                                        </a>
                                    </th>*@
                                    </tr>
                                </thead>
                                <tbody>
                                    @*<tr>
                                    <td style="text-align:center !important">1</td>
                                    <td style="text-align:center !important">RE67-011002</td>
                                    <td style="text-align:center !important" class="bg-new">New</td>
                                    <td>เล้าพ่อพันธุ์</td>
                                    <td>8881</td>
                                    <td>พ่อพันธุ์</td>
                                    <td>SH670003</td>
                                    <td style="text-align:right !important"><input type="text" id="buyBaht" value="14251.63" class="form-control bg-input" style="text-align: right;" /></td>
                                    <td style="text-align:right !important"><input type="text" id="carcass" value="4000" class="form-control bg-input" style="text-align: right;" /></td>
                                    <td style="text-align:right !important">10,251.63</td>
                                    <td style="text-align:center !important">
                                        <input type="text"
                                                style="text-align: center;"
                                                id="date1"
                                                class="form-control bg-input"
                                                placeholder=""
                                                aria-label="Username"
                                                aria-describedby="basic-addon1"
                                                value="11-Jan-2024" />
                                    </td>
                                    <td class="text-new">
                                        <input type="text"
                                                style="text-align: center;"
                                                id="date2"
                                                class="form-control bg-input"
                                                placeholder=""
                                                aria-label="Username"
                                                aria-describedby="basic-addon1"
                                                value="11-Jan-2024" />
                                    </td>
                                    <td style="text-align:center !important" class="bg-disabled">10-Jan-2027</td>
                                    <td style="text-align:right !important" class="bg-disabled">3</td>
                                    <td style="text-align:right !important" class="bg-disabled">1096</td>
                                    <td style="text-align:right !important" class="bg-disabled">9.3537</td>
                                    <td style="text-align:center !important" class="bg-disabled">10-Jan-2029</td>
                                    <td style="text-align:right !important" class="bg-disabled">5</td>
                                    <td style="text-align:right !important" class="bg-disabled">1826</td>
                                    <td style="text-align:right !important" class="bg-disabled">5.61</td>
                                    <td style="text-align:center !important" class="bg-disabled">16-Oct-2024</td>
                                    <td style="text-align:right !important" class="bg-disabled">282</td>
                                    <td style="text-align:right !important" class="bg-disabled">11,609.44</td>
                                    <td style="text-align:center !important">Active</td>
                                    <td>
                                        <div class="d-flex align-items-center selectgroup-pills">
                                            <button type="button"
                                                    id="newEdit"
                                                    class="selectgroup-button selectgroup-button-icon">
                                                <i class="fas fa-edit text-warning"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="text-align:center !important">2</td>
                                    <td style="text-align:center !important">RE67-011002</td>
                                    <td style="text-align:center !important " class="bg-new">New</td>
                                    <td>เล้าผสมและอุ้มท้อง</td>
                                    <td>8882</td>
                                    <td>แม่พันธุ์</td>
                                    <td>HH670004</td>
                                    <td style="text-align:right !important"><input type="text" value="14251.63" class="form-control bg-input" style="text-align: right;" /></td>
                                    <td style="text-align:right !important"><input type="text" value="4000" class="form-control bg-input" style="text-align: right;" /></td>
                                    <td style="text-align:right !important">10,251.63</td>
                                    <td style="text-align:center !important">
                                        <input type="text"
                                                style="text-align: center;"
                                                id="date3"
                                                class="form-control bg-input"
                                                placeholder=""
                                                aria-label="Username"
                                                aria-describedby="basic-addon1"
                                                value="11-Jan-2024" />
                                    </td>
                                    <td>
                                        <input type="text"
                                                style="text-align: center;"
                                                id="date4"
                                                class="form-control bg-input"
                                                placeholder=""
                                                aria-label="Username"
                                                aria-describedby="basic-addon1"
                                                value="11-Jan-2024" />
                                    </td>
                                    <td style="text-align:center !important" class="bg-disabled">10-Jan-2026</td>
                                    <td style="text-align:right !important" class="bg-disabled">2</td>
                                    <td style="text-align:right !important" class="bg-disabled">731</td>
                                    <td style="text-align:right !important" class="bg-disabled">14.0241</td>
                                    <td style="text-align:center !important" class="bg-disabled">10-Jan-2028</td>
                                    <td style="text-align:right !important" class="bg-disabled">5</td>
                                    <td style="text-align:right !important" class="bg-disabled">1460</td>
                                    <td style="text-align:right !important" class="bg-disabled">7.02</td>
                                    <td style="text-align:center !important" class="bg-disabled">16-Oct-2024</td>
                                    <td style="text-align:right !important" class="bg-disabled">282</td>
                                    <td style="text-align:right !important" class="bg-disabled">10,290.15</td>
                                    <td style="text-align:center !important">Active</td>
                                    <td>
                                        <div class="d-flex align-items-center selectgroup-pills">
                                            <button type="button"
                                                    class="selectgroup-button selectgroup-button-icon">
                                                <i class="fas fa-edit text-warning"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="text-align:center !important">3</td>
                                    <td style="text-align:center !important;">RE67-011001</td>
                                    <td></td>
                                    <td>เล้าพ่อพันธุ์</td>
                                    <td>1234A</td>
                                    <td>พ่อพันธุ์</td>
                                    <td>SH670001</td>
                                    <td style="text-align:right !important">14251.63</td>
                                    <td style="text-align:right !important">4000</td>
                                    <td style="text-align:right !important">10,251.63</td>
                                    <td style="text-align:center !important">10-Jan-2024</td>
                                    <td style="text-align:center !important">10-Jan-2024</td>
                                    <td style="text-align:center !important" class="bg-disabled">09-Jan-2027</td>
                                    <td style="text-align:right !important" class="bg-disabled">3</td>
                                    <td style="text-align:right !important" class="bg-disabled">1096</td>
                                    <td style="text-align:right !important" class="bg-disabled">9.3537</td>
                                    <td style="text-align:center !important" class="bg-disabled">09-Jan-2029</td>
                                    <td style="text-align:right !important" class="bg-disabled">5</td>
                                    <td style="text-align:right !important" class="bg-disabled">1826</td>
                                    <td style="text-align:right !important" class="bg-disabled">5.61</td>
                                    <td style="text-align:center !important" class="bg-disabled">16-Oct-2024</td>
                                    <td style="text-align:right !important" class="bg-disabled">282</td>
                                    <td style="text-align:right !important" class="bg-disabled">11,616.73</td>
                                    <td style="text-align:center !important">Active</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td style="text-align:center !important">4</td>
                                    <td style="text-align:center !important">RE67-011001</td>
                                    <td></td>
                                    <td>เล้าผสมและอุ้มท้อง</td>
                                    <td>1234B</td>
                                    <td>แม่พันธุ์</td>
                                    <td>HH670002</td>
                                    <td style="text-align:right !important">14251.63</td>
                                    <td style="text-align:right !important">4000</td>
                                    <td style="text-align:right !important">10,251.63</td>
                                    <td style="text-align:center !important">10-Jan-2024</td>
                                    <td style="text-align:center !important">10-Jan-2024</td>
                                    <td style="text-align:center !important" class="bg-disabled">09-Jan-2026</td>
                                    <td style="text-align:right !important" class="bg-disabled">2</td>
                                    <td style="text-align:right !important" class="bg-disabled">731</td>
                                    <td style="text-align:right !important" class="bg-disabled">14.0241</td>
                                    <td style="text-align:center !important" class="bg-disabled">09-Jan-2028</td>
                                    <td style="text-align:right !important" class="bg-disabled">5</td>
                                    <td style="text-align:right !important" class="bg-disabled">1826</td>
                                    <td style="text-align:right !important" class="bg-disabled">5.61</td>
                                    <td style="text-align:center !important" class="bg-disabled">16-Oct-2024</td>
                                    <td style="text-align:right !important" class="bg-disabled">282</td>
                                    <td style="text-align:right !important" class="bg-disabled">10,301.09</td>
                                    <td style="text-align:center !important">Active</td>
                                    <td></td>
                                </tr>*@
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-12 col-lg-12">
                            <div class="form-group">
                                <div class="input-group mb-3" style="justify-content:flex-end !important">
                                    <button id="calculate" class="btn btn-primary btn-round">คำนวณค่าเสื่อมพันธุ์</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        if ('@ViewBag.searchDocNo' != '') {
            $("#searchDocNo").val(JSON.parse('@Html.Raw(Json.Encode(ViewBag.searchDocNo))')).trigger("change");
        }
        if ('@ViewBag.searchSiteid' != '') {
            $("#searchSiteId").val(JSON.parse('@Html.Raw(Json.Encode(ViewBag.searchSiteId))')).trigger("change");
        }
        if ('@ViewBag.searchHousingTypeCode' != '') {
            $("#searchHousingTypeCode").val(JSON.parse('@Html.Raw(Json.Encode(ViewBag.searchHousingTypeCode))')).trigger("change");
        }
        if ('@ViewBag.searchBreeder' != '') {
            $("#searchBreeder").val(JSON.parse('@Html.Raw(Json.Encode(ViewBag.searchBreeder))')).trigger("change");
        }
        if ('@ViewBag.searchType' != '') {
            $("#searchType").val(JSON.parse('@Html.Raw(Json.Encode(ViewBag.searchType))')).trigger("change");
        }
        if ('@ViewBag.searchFromBrdrId' != '') {
            $("#searchFromBrdrId").val(JSON.parse('@Html.Raw(Json.Encode(ViewBag.searchFromBrdrId))')).trigger("change");
        }
        if ('@ViewBag.searchToBrdrId' != '') {
            $("#searchToBrdrId").val(JSON.parse('@Html.Raw(Json.Encode(ViewBag.searchToBrdrId))')).trigger("change");
        }
        if ('@ViewBag.searchStatus' != '') {
            $("#searchStatus").val(JSON.parse('@Html.Raw(Json.Encode(ViewBag.searchStatus))')).trigger("change");
        }

        $('#searchDocNo, #searchSiteId, #searchHousingTypeCode, #searchBreeder, #searchFromBrdrId, #searchToBrdrId').select2({
                theme: "bootstrap-5",
                width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style',
                placeholder: $(this).data('placeholder'),
                closeOnSelect: true,
                tags: true
        });

        if ($("#bookValueDate").val() == null || $("#bookValueDate").val() == '') {
            $("#bookValueDate").datepicker({
                todayHighlight: true,
                orientation: 'bottom left',
                format: 'dd-M-yyyy',
                todayBtn: 'linked',
                autoclose: 'true',
                assumeNearbyYear: true,
            }).datepicker("setDate", 'now');
        } else {
            $("#bookValueDate").datepicker({
                todayHighlight: true,
                orientation: 'bottom left',
                format: 'dd-M-yyyy',
                todayBtn: 'linked',
                autoclose: 'true',
                assumeNearbyYear: true,
            });
        }

        var currentdate = new Date();
        tableDetail = $("#tb_detail").DataTable({
            lengthChange: false,
            "processing": true, // for show progress bar
            "orderMulti": false, // for disable multiple column at once
            "pageLength": 20,
            scrollCollapse: true,
            paging: true,
            searching: false,
            responsive: !0,
            ordering: true,
            info: true,
            bAutoWidth: false,
            order: [[1, "asc"]],
            "ajax": {
                url: pathServer + "/DPC/CALDPCDT01_SELECT",
                type: "POST",
                datatype: "json",
                data: {
                    searchDocNo: $("#searchDocNo").val(),
                    searchSiteId: $("#searchSiteId").val(),
                    searchHousingTypeCode: $("#searchHousingTypeCode").val(),
                    searchBreeder: $("#searchBreeder").val(),
                    searchType: $("#searchType").val(),
                    searchFromBrdrId: $("#searchFromBrdrId").val(),
                    searchToBrdrId: $("#searchToBrdrId").val(),
                    searchStatus: $("#searchStatus").val()
                },
            },
            "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                if (aData.ST == 'N') {
                    $('td', nRow).eq(2).addClass('bg-new-green');
                }
                $('td', nRow).eq(12).addClass('bg-disabled-gray');
                $('td', nRow).eq(13).addClass('bg-disabled-gray');
                $('td', nRow).eq(14).addClass('bg-disabled-gray');
                $('td', nRow).eq(15).addClass('bg-disabled-gray');
                $('td', nRow).eq(16).addClass('bg-disabled-gray');
                $('td', nRow).eq(17).addClass('bg-disabled-gray');
                $('td', nRow).eq(18).addClass('bg-disabled-gray');
                $('td', nRow).eq(19).addClass('bg-disabled-gray');
                $('td', nRow).eq(20).addClass('bg-disabled-gray');
                $('td', nRow).eq(21).addClass('bg-disabled-gray');
                $('td', nRow).eq(22).addClass('bg-disabled-gray');
                $('td', nRow).eq(23).addClass('bg-disabled-gray');
            },
            columnDefs: [
                {
                    targets: [0],
                    orderable: false,
                    className: "text-center",
                },
                {
                    targets: [1],
                    visible: false
                },
                {
                    targets: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
                    orderable: false,
                    className: "text-left",
                },
            ],
            "columns": [
                {
                    "render": function (data, type, full, meta) {
                        var page = (Math.ceil(meta.settings._iDisplayStart / meta.settings._iDisplayLength)); // index row
                        return (meta.row + 1) + page;
                    }
                },
                { 'data': 'BRDR_DPRC_SK' },
                { 'data': 'DOC_NO' },
                {
                    'data': 'ST',
                    render: function (data, type, row, meta) {
                        if (data == 'N') {
                            return "<div class='text-center'>New</div>";
                        }
                        else if (data == 'A') {
                            return "<div class='text-center'>Active</div>";
                        }
                        else if (data == 'I') {
                            return "<div class='text-center'>InActive</div";
                        }
                        else { return '' }
                    }
                },
                { 'data': 'HSG_ID' },
                { 'data': 'BRDR_ID_USED' },
                {
                    'data': 'BRDR_TP',
                    render: function (data, type, row) {
                        return data == 'F' ? 'แม่พันธุ์' : 'พ่อพันธุ์'
                    }
                },
                { 'data': 'BRDR_DPRC_CODE' },
                {
                    'data': 'COST_AMT',
                    render: function (data, type, row, meta) {
                        if (row.ST == 'N' || ((dateDiff(new Date(resJsonToDate(row.CRT_DT)), currentdate) == 0) && (currentdate.getHours() <= 23 && currentdate.getMinutes() <= 59))) {
                            return "<input type='text' class='form-control int' autocomplete='off' id='COST_AMT--" + row.UK_KEY + "' row='" + meta.row + "' col='" + meta.col + "' value='" + numeral(data).format('0,0.00') + "' onchange='ModifyDirectly(this)' style='color: rgb(12, 63, 245) !important;' />";
                        } else {
                            return numeral(data).format('0,0.00');
                        }
                    }
                },
                {
                    'data': 'SCRP_VAL',
                    render: function (data, type, row, meta) {
                        if (row.ST == 'N' || ((dateDiff(new Date(resJsonToDate(row.CRT_DT)), currentdate) == 0) && (currentdate.getHours() <= 23 && currentdate.getMinutes() <= 59))) {
                            return "<input type='text' class='form-control int' autocomplete='off' id='SCRP_VAL--" + row.UK_KEY + "' row='" + meta.row + "' col='" + meta.col + "' value='" + numeral(data).format('0,0.00') + "' onchange='ModifyDirectly(this)' style='color: rgb(12, 63, 245) !important;'/>";
                        } else {
                            return numeral(data).format('0,0.00');
                        }
                    }
                },
                {
                    'data': 'NET_VAL',
                    render: function (data, type, row) {
                        return numeral(data).format('0,0.00');
                    }
                },
                {
                    'data': 'RCV_DT',
                    render: function (data, type, row, meta) {
                        return resJsonToDate(data);
                    }
                },
                {
                    'data': 'ST_DT',
                    render: function (data, type, row, meta) {
                        if (row.ST == 'N' || ((dateDiff(new Date(resJsonToDate(row.CRT_DT)), currentdate) == 0) && (currentdate.getHours() <= 23 && currentdate.getMinutes() <= 59))) {
                            return "<input type='text' class='form-control startDate' id='ST_DT--" + row.UK_KEY + "' row='" + meta.row + "' col='" + meta.col + "' value='" + resJsonToDate(row.ST_DT) + "' onchange='ModifyDirectly(this)' style='color: rgb(12, 63, 245) !important;' />";
                        } else {
                            return resJsonToDate(data);
                        }
                    }
                },
                {
                    'data': 'END_DT',
                    render: function (data, type, row) {
                        return resJsonToDate(data);
                    }
                },
                { 'data': 'YEAR_QTY' },
                { 'data': 'DAY_QTY' },
                {
                    'data': 'DPRC_P_DAY',
                    render: function (data, type, row) {
                        return numeral(data).format('0,0.00');
                    }
                },
                {
                    'data': 'END_DT_5_YR',
                    render: function (data, type, row) {
                        return resJsonToDate(data);
                    }
                },
                { 'data': 'YR_QTY_5Y' },
                { 'data': 'DY_QTY_5Y' },
                {
                    'data': 'DPRC_DY_5Y',
                    render: function (data, type, row) {
                        return numeral(data).format('0,0.00');
                    }
                },
                {
                    'data': 'BOOK_DT',
                    render: function (data, type, row) {
                        return resJsonToDate(data);
                    }
                },
                { 'data': 'BOOK_DT_QTY' },
                {
                    'data': 'BOOK_VALUE',
                    render: function (data, type, row) {
                        return numeral(data).format('0,0.00');
                    }
                }
            ],
            drawCallback: function (row, data, index) {
                var api = this.api();
                $(".startDate").datepicker({
                    todayHighlight: true,
                    orientation: 'bottom left',
                    format: 'dd-M-yyyy',
                    todayBtn: 'linked',
                    autoclose: 'true',
                    assumeNearbyYear: true
                });
                $(row).addClass('bg-disabled');
            }
        });

        tableDetail.on('order.dt', function () {
            tableDetail.column(0, { order: 'applied' }).nodes().each(function (cell, i) {
                cell.innerHTML = i + 1;
            });
        }).draw(false);

    });

    function dateDiff(d1, d2) {
        var t2 = d2.getTime();
        var t1 = d1.getTime();

        return Math.floor((t2 - t1) / (24 * 3600 * 1000));
    }

    function yearsDiff(d1, d2) {
        return d2.getFullYear() - d1.getFullYear();
    }

    function dateToJson(value) {
        var unixTimestamp = new Date(value).getTime();
        return `/Date(${unixTimestamp})/`;
    }

    function clone(obj) {
        var copy;
        // Handle the 3 simple types, and null or undefined
        if (null == obj || "object" != typeof obj) return obj;
        if (obj instanceof Date) {
            copy = new Date();
            copy.setTime(obj.getTime());
            return copy;
        }
        if (obj instanceof Array) {
            copy = [];
            for (var i = 0, len = obj.length; i < len; i++) {
                copy[i] = clone(obj[i]);
            }
            return copy;
        }
        if (obj instanceof Object) {
            copy = {};
            for (var attr in obj) {
                if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
            }
            return copy;
        }
        throw new Error("Unable to copy obj! Its type isn't supported.");
    }

    function ModifyDirectly(btn) {
        var id = $(btn).attr('id');
        var row = $(btn).attr('row');
        var col = $(btn).attr('col');
        var values = $("#" + id).val();
        var id_dt = id.split('--')[0]
        var key = id.split('--')[1];
        focus = id;

        if (id_dt == 'ST_DT') {
            values = dateToJson(values);
        }

        var indexDetail = tableDetail.rows().indexes().filter(function (value, index) {
                return key === tableDetail.row(value).data().UK_KEY;
        });

        var check = true;
        if (indexDetail !== undefined && tableDetail.row(indexDetail).length > 0) {
            var page = tableDetail.page.info();
            if (check == true) {
                tableDetail.page(page.page).cell(row, col).data(values).draw(false);
                Calculate(indexDetail);
            } else {
                tableDetail.page(page.page).cell(row, col).data(null).draw(false);
            }
        } else {
            console.log("Invalid row index:", indexDetail);
        }
    }

    function Calculate(indexDetail) {
        var page = tableDetail.page.info();

        const netValue = (numeral(tableDetail.row(indexDetail).data().COST_AMT)._value - numeral(tableDetail.row(indexDetail).data().SCRP_VAL)._value);
        const startDate = new Date(resJsonToDate(tableDetail.row(indexDetail).data().ST_DT));
        const receiveDate = new Date(resJsonToDate(tableDetail.row(indexDetail).data().RCV_DT));
           receiveDate.setFullYear(receiveDate.getFullYear() + (tableDetail.row(indexDetail).data().BRDR_TP == 'F' ? 3 : 2));
           receiveDate.setDate(receiveDate.getDate() - 1);
        const endDate = new Date(receiveDate);
        const yearQty = tableDetail.row(indexDetail).data().BRDR_TP == 'F' ? 3 : 2;

        const stDate1 = clone(startDate);
        const enDate1 = clone(endDate);
        const dayQty = dateDiff(stDate1, enDate1);
        const depreciatePerDay = netValue / dayQty
        const endDay5Year = new Date(stDate1.setFullYear(stDate1.getFullYear() + 5));
        const yearQty5Year = yearsDiff(startDate, endDay5Year);
        const dayQty5Year = dateDiff(startDate, endDay5Year);
        const depreciatePer5Year = netValue / dayQty5Year

        const stDate2 = clone(startDate);
        const currentDate = new Date();
        const bookValueDate = dateDiff(stDate2, new Date(currentDate.setDate(currentDate.getDate() + 1)));
        const bookValue = numeral(tableDetail.row(indexDetail).data().COST_AMT)._value - ((netValue / dayQty) * bookValueDate)

        tableDetail.row(indexDetail).data().NET_VAL = numeral(netValue)._value;
        tableDetail.row(indexDetail).data().END_DT = dateToJson(endDate);
        tableDetail.row(indexDetail).data().YEAR_QTY = numeral(yearQty)._value;
        tableDetail.row(indexDetail).data().DAY_QTY = numeral(dayQty)._value;
        tableDetail.row(indexDetail).data().DPRC_P_DAY = numeral(depreciatePerDay)._value;
        tableDetail.row(indexDetail).data().END_DT_5_YR = dateToJson(endDay5Year);
        tableDetail.row(indexDetail).data().YR_QTY_5Y = yearQty5Year;
        tableDetail.row(indexDetail).data().DY_QTY_5Y = dayQty5Year;
        tableDetail.row(indexDetail).data().DPRC_DY_5Y = depreciatePer5Year;
        tableDetail.row(indexDetail).data().BOOK_DT_QTY = bookValueDate;
        tableDetail.row(indexDetail).data().BOOK_VALUE = bookValue;

        tableDetail.row(indexDetail).data(tableDetail.row(indexDetail).data()).draw();
        tableDetail.page(page.page).draw(false);

        console.log(tableDetail.row(indexDetail).data());
    }

    $("#calBookValue").click(function () {
        let page = tableDetail.page.info();
        let bookDate = $('#bookValueDate').val();

        for (let i = 0; i < tableDetail.data().length; i++) {
            tableDetail.row(i).data().BOOK_DT = dateToJson(bookDate);
            Calculate(i);
        }
    });

    $("#calculate").click(function () {
        Swal.fire({
            icon: "question",
            title: 'Do you want to calculate?',
            text: "Are you sure to calculate and save this data",
            showCancelButton: true,
            confirmButtonText: 'Yes',
        }).then((result) => {
            if (result.isConfirmed) {
                save();
            }
        });
    });

    function save() {
        var currentDate = new Date();
        var BRDR_DPRC = new Array();
        for (var i = 0; i < tableDetail.data().length; i++) {
            var tb_dprc = {};

            if (tableDetail.data()[i].ST == 'N' || ((dateDiff(new Date(resJsonToDate(tableDetail.data()[i].CRT_DT)), currentDate) == 0) && (currentDate.getHours() <= 23 && currentDate.getMinutes() <= 59))) {
                tb_dprc.BRDR_ID = tableDetail.data()[i].BRDR_ID_USED;
                tb_dprc.BRDR_DPRC_CODE = tableDetail.data()[i].BRDR_DPRC_CODE;
                tb_dprc.ST = tableDetail.data()[i].ST;
                tb_dprc.COST_AMT = numeral(tableDetail.data()[i].COST_AMT)._value;
                tb_dprc.SCRP_VAL = numeral(tableDetail.data()[i].SCRP_VAL)._value;
                tb_dprc.NET_VAL = numeral(tableDetail.data()[i].NET_VAL)._value;
                tb_dprc.DT = resJsonToDate(tableDetail.data()[i].ST_DT);

                tb_dprc.NO_OF_YR_FOR_DPRC_1 = numeral(tableDetail.data()[i].YEAR_QTY)._value;
                tb_dprc.TOT_DAY_AMT_DPRC_1 = dateDiff(currentDate, new Date(resJsonToDate(tableDetail.data()[i].END_DT)));
                tb_dprc.DPRC_RATE_PER_DAY_1 = numeral(tableDetail.data()[i].DPRC_P_DAY)._value;
                tb_dprc.LAST_DAY_DPRC_1 = resJsonToDate(tableDetail.data()[i].END_DT);

                tb_dprc.NO_OF_YEAR_FOR_DPRC_2 = numeral(tableDetail.data()[i].YR_QTY_5Y)._value;
                tb_dprc.TOT_DAY_AMT_DPRC_2 = dateDiff(currentDate, new Date(resJsonToDate(tableDetail.data()[i].END_DT_5_YR)));
                tb_dprc.DPRC_RATE_PER_DAY_2 = numeral(tableDetail.data()[i].DPRC_DY_5Y)._value;
                tb_dprc.LAST_DAY_DPRC_2 = resJsonToDate(tableDetail.data()[i].END_DT_5_YR);

                tb_dprc.BOOK_VAL = numeral(tableDetail.data()[i].BOOK_VALUE)._value;
                tb_dprc.TOT_DAY_OF_BOOK_VAL = numeral(tableDetail.data()[i].BOOK_DT_QTY)._value;
                BRDR_DPRC.push(tb_dprc);
            }
        } 

        $.ajax({
            contentType: "application/json; charset=utf-8",// กำหนด content สำหรับส่งข้อมูลแบบ object or list
            type: "POST",
            url: pathServer + "/DPC/CALDPCDT01_INSERT",
            dataType: "json",
            data: JSON.stringify({ BRDR_DPRC: BRDR_DPRC }), //parameter Object,List
            xhr: function () {
                var xhr = new window.XMLHttpRequest();
                let timerInterval;
                xhr_loading(xhr);
                clearInterval(timerInterval);
                return xhr;
            },
            success: function (data) {

                clearInterval(interVal);
                $('#progress').css('width', 100 + "%");
                //successMessage.init();
                setTimeout(function () {
                    //Attach_File();
                    Swal.fire({
                        icon: "success",
                        title: 'Your data has been saved',
                        showConfirmButton: true,
                        confirmButtonText: 'OK'
                    }).then((result) => {
                        location.reload();
                    });
                }, 1500);
            },
            error: function () {
                errorAlert.init();
            }
        });
    }

</script>
